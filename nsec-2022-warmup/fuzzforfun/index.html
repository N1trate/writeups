<!doctype html><html><head><title>Nitrate's writeups</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2022-07-18T14:31:54 UTC"><title>FuzzForFun :: Nitrate's writeups</title><link rel="shortcut icon" href=/writeups/images/favicon.png type=image/x-icon><link href=/writeups/css/nucleus.css rel=stylesheet><link href=/writeups/css/font-awesome.min.css rel=stylesheet><link href=/writeups/css/featherlight.min.css rel=stylesheet><link href=/writeups/css/auto-complete.css rel=stylesheet><link href=/writeups/theme-flex/style.css rel=stylesheet><link rel=stylesheet href=/writeups/css/bootstrap.min.css><link rel=stylesheet href=/writeups/css/custom.css></head><body data-url=/writeups/nsec-2022-warmup/fuzzforfun/><header><div class=logo><a class=baselink href=https://n1trate.github.io/writeups>Nitrate's writeups</a></div><div class=burger><a href=javascript:void(0); style=font-size:15px>&#9776;</a></div></header><article><aside><ul class=menu><li data-nav-id=/ class=dd-item><a href=/><i class="fa fa-fw fa-home"></i></a></li><li data-nav-id=https://n1trate.github.io/writeups/htb-business-ctf-2022-dirty-money/ class="dd-item alwaysopen haschildren"><div><a href=/writeups/htb-business-ctf-2022-dirty-money/>HTB Business CTF 2022: Dirty Money</a>
<i class="fa fa-angle-down fa-lg category-icon"></i></div><ul><li data-nav-id=https://n1trate.github.io/writeups/htb-business-ctf-2022-dirty-money/linas-invitation/ class=dd-item><div><a href=/writeups/htb-business-ctf-2022-dirty-money/linas-invitation/>Lina's Invitation</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/htb-business-ctf-2022-dirty-money/mbcoin/ class=dd-item><div><a href=/writeups/htb-business-ctf-2022-dirty-money/mbcoin/>MBCoin</a></div></li></ul></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022/ class="dd-item alwaysopen haschildren"><div><a href=/writeups/nsec-2022/>NSec 2022</a>
<i class="fa fa-angle-down fa-lg category-icon"></i></div><ul><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022/portobello-denial/ class=dd-item><div><a href=/writeups/nsec-2022/portobello-denial/>Portobello - Denial</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022/portobello-depression/ class=dd-item><div><a href=/writeups/nsec-2022/portobello-depression/>Portobello - Depression</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022/portobello-bargaining/ class=dd-item><div><a href=/writeups/nsec-2022/portobello-bargaining/>Portobello - Bargaining</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022/portobello-anger/ class=dd-item><div><a href=/writeups/nsec-2022/portobello-anger/>Portobello - Anger</a></div></li></ul></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/ class="dd-item alwaysopen haschildren"><div><a href=/writeups/nsec-2022-warmup/>NSec 2022 WarmUp</a>
<i class="fa fa-angle-down fa-lg category-icon"></i></div><ul><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/kitty/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/kitty/>Kitty!</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/warmup-challenge-logically/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/warmup-challenge-logically/>Warmup challenge, logically</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/the-flag-is-a-secret/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/the-flag-is-a-secret/>The Flag Is A Secret</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/toque-tracking/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/toque-tracking/>Toque Tracking</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/northsec-flag-token/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/northsec-flag-token/>NorthSec Flag Token</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/vlc-of-the-mariner/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/vlc-of-the-mariner/>VLC of the Mariner</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/whamazon/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/whamazon/>Whamazon</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/warmup-flag-actual/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/warmup-flag-actual/>warmup flag (actual)</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/hidden-harware-secrets/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/hidden-harware-secrets/>Hidden Hardware Secrets</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/fuzzforfun/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/fuzzforfun/>FuzzForFun</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/montr%C3%A9al-remix/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/montr%C3%A9al-remix/>Montréal Remix</a></div></li></ul></li><li data-nav-id=https://n1trate.github.io/writeups/tools/ class="dd-item alwaysopen"><div><a href=/writeups/tools/>Tools</a></div></li></ul><section></section></aside><section class=page><div class=nav-select><center>Navigation :
<select onchange="location.href=this.value"><option value=/writeups/htb-business-ctf-2022-dirty-money/>
HTB Business CTF 2022: Dirty Money</option><option value=/writeups/htb-business-ctf-2022-dirty-money/linas-invitation/>
-
Lina's Invitation</option><option value=/writeups/htb-business-ctf-2022-dirty-money/mbcoin/>
-
MBCoin</option><option value=/writeups/nsec-2022/>
NSec 2022</option><option value=/writeups/nsec-2022/portobello-denial/>
-
Portobello - Denial</option><option value=/writeups/nsec-2022/portobello-depression/>
-
Portobello - Depression</option><option value=/writeups/nsec-2022/portobello-bargaining/>
-
Portobello - Bargaining</option><option value=/writeups/nsec-2022/portobello-anger/>
-
Portobello - Anger</option><option value=/writeups/nsec-2022-warmup/>
NSec 2022 WarmUp</option><option value=/writeups/nsec-2022-warmup/kitty/>
-
Kitty!</option><option value=/writeups/nsec-2022-warmup/warmup-challenge-logically/>
-
Warmup challenge, logically</option><option value=/writeups/nsec-2022-warmup/the-flag-is-a-secret/>
-
The Flag Is A Secret</option><option value=/writeups/nsec-2022-warmup/toque-tracking/>
-
Toque Tracking</option><option value=/writeups/nsec-2022-warmup/northsec-flag-token/>
-
NorthSec Flag Token</option><option value=/writeups/nsec-2022-warmup/vlc-of-the-mariner/>
-
VLC of the Mariner</option><option value=/writeups/nsec-2022-warmup/whamazon/>
-
Whamazon</option><option value=/writeups/nsec-2022-warmup/warmup-flag-actual/>
-
warmup flag (actual)</option><option value=/writeups/nsec-2022-warmup/hidden-harware-secrets/>
-
Hidden Hardware Secrets</option><option value=/writeups/nsec-2022-warmup/fuzzforfun/ selected>
-
FuzzForFun</option><option value=/writeups/nsec-2022-warmup/montr%C3%A9al-remix/>
-
Montréal Remix</option><option value=/writeups/tools/>
Tools</option></select></center></div><div><div class=searchbox><input data-search-input id=search-by type=text placeholder=Search...></div></div><h1>FuzzForFun</h1><p>Challenge statement:</p><pre tabindex=0><code>Fuzz the parser and find the bug! The goal is to find a reproducible bug in the ESIF parser. We&#39;re looking for an exploitable vulnerability. &#34;Theoretical bugs&#34; or code warnings are not welcome, sorry.
</code></pre><p>After downloading the <a href=FuzzForFun-20220506T164604Z-001.zip>zip</a> file, we could read the content of the HOWTO, which gives a very big help on where to start:</p><pre tabindex=0><code>1) The goal is to find a reproducible bug on the ESIF parser. We&#39;re looking for an exploitable vulnerability. &#34;Theoretical bugs&#34; or code warnings are not welcome, sorry.
2) The challenge is intended to be solved by fuzzing, but creative approaches will be encouraged.
3) You can build the parser with: 
	gcc Source.c -o Source -lcrypto -lssl -lm -w
4) Then you can parse the example file with the following command:
	./Source example.ESIF output
5) I recommend you to use AFL++, but you can use whatever other fuzzer you want.
6) Once you have a crash file, you can get the flag with the following command:
	./Check &lt;CrashFile&gt;
7) Enjoy!
TIP: Take a look at https://github.com/antonio-morales/Fuzzing101
</code></pre><p>Based on <a href=https://github.com/antonio-morales/Fuzzing101/tree/main/Exercise%201>Exercise 1</a>, we can install afl++.</p><p>We can create an &ldquo;examples&rdquo; and &ldquo;outputs&rdquo; folder, and put the example.ESIF into the examples folder.</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get install -y build-essential python3-dev automake git flex bison libglib2.0-dev libpixman-1-dev python3-setuptools
</span></span><span style=display:flex><span>sudo apt-get install -y lld-11 llvm-11 llvm-11-dev clang-11 || sudo apt-get install -y lld llvm llvm-dev clang 
</span></span><span style=display:flex><span>sudo apt-get install -y gcc-<span style=color:#fff;font-weight:700>$(</span>gcc --version|head -n1|sed <span style=color:#0ff;font-weight:700>&#39;s/.* //&#39;</span>|sed <span style=color:#0ff;font-weight:700>&#39;s/\..*//&#39;</span><span style=color:#fff;font-weight:700>)</span>-plugin-dev libstdc++-<span style=color:#fff;font-weight:700>$(</span>gcc --version|head -n1|sed <span style=color:#0ff;font-weight:700>&#39;s/.* //&#39;</span>|sed <span style=color:#0ff;font-weight:700>&#39;s/\..*//&#39;</span><span style=color:#fff;font-weight:700>)</span>-dev
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>cd</span> $HOME
</span></span><span style=display:flex><span>git clone https://github.com/AFLplusplus/AFLplusplus &amp;&amp; <span style=color:#fff;font-weight:700>cd</span> AFLplusplus
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>export</span> LLVM_CONFIG=<span style=color:#0ff;font-weight:700>&#34;llvm-config-11&#34;</span>
</span></span><span style=display:flex><span>make distrib
</span></span><span style=display:flex><span>sudo make install
</span></span></code></pre></div><p>During the installation, you need to make sure that you fix whatever problem that comes up during those steps. I was missing cmake and gcc-X-plugin-dev, which in my case was gcc-9-plugin-dev.</p><p>We can then compile our executable with the AFL instrumentation and start the fuzzer with the following:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#fff;font-weight:700>export</span> LLVM_CONFIG=<span style=color:#0ff;font-weight:700>&#34;llvm-config-11&#34;</span>
</span></span><span style=display:flex><span>CC=$HOME/AFLplusplus/afl-clang-fast CXX=$HOME/AFLplusplus/afl-clang-fast++ $HOME/AFLplusplus/afl-gcc-fast Source.c -o Source -lcrypto -lssl -lm -w
</span></span><span style=display:flex><span>/usr/local/bin/afl-fuzz -i examples -o outputs -s <span style=color:#ff0;font-weight:700>123</span> -- ./Source @@ outputs/output
</span></span></code></pre></div><p><img src=default.png alt=default.png></p><p>Now it&rsquo;s time to wait. While waiting, I also tried to run it in a docker container, to see if the speed would be better than a VM, but it was not. For references, here are the steps to make it work in a docker container:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -ti -v <span style=color:#0ff;font-weight:700>&#34;</span><span style=color:#fff;font-weight:700>$(</span><span style=color:#fff;font-weight:700>pwd</span><span style=color:#fff;font-weight:700>)</span><span style=color:#0ff;font-weight:700>:/home&#34;</span> aflplusplus/aflplusplus
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>export</span> HOME=<span style=color:#0ff;font-weight:700>&#34;/home&#34;</span>
</span></span><span style=display:flex><span>afl-gcc Source.c -o Source -lcrypto -lssl -lm -w
</span></span><span style=display:flex><span>afl-fuzz -i examples/ -o outputs/ -s <span style=color:#ff0;font-weight:700>123</span> -- ./Source @@ outputs/output
</span></span></code></pre></div><p>At some point I tried to enable bit/byte flips and such by using the -D switch.</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>AFL_AUTORESUME=<span style=color:#ff0;font-weight:700>1</span> /usr/local/bin/afl-fuzz -D -i examples -o outputs -s <span style=color:#ff0;font-weight:700>123</span> -- ./Source @@ outputs/output
</span></span></code></pre></div><p><img src=1h.png alt=1h.png></p><p>After more than an hour, I thought that maybe I had to try a different approach. I looked into trying to give more information on the file structure of the input to AFL, but I wasn&rsquo;t even sure what the program expected, or how to do such thing with AFL.</p><p>I decided to run the check program on the sample output, to see the result, and it gave the following:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./Check output
</span></span><span style=display:flex><span>nsec2022_2665387
</span></span></code></pre></div><p>Maybe that number is a hint on which seed to use, so I tried to run it with the seed being 2665387. With or without the -D option, it did not do much better.</p><p>I decided to keep reading those exercises, and finally got to <a href=https://github.com/antonio-morales/Fuzzing101/tree/main/Exercise%203>Exercise 3</a>. One thing that it brings up is to use afl-clang-lto instead of afl-gcc/afl-gcc-fast to compile the application. I ended up having other issues, and didn&rsquo;t think I was supposed to fix the compilation problems.<br><img src=clang-lto.png alt=clang-lto.png></p><p>The other thing that Exercise 3 was doing differently was to build with ASan, the Address Sanitizer, enabled. So I tried</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>AFL_USE_ASAN=<span style=color:#ff0;font-weight:700>1</span> CC=$HOME/AFLplusplus/afl-clang-fast CXX=$HOME/AFLplusplus/afl-clang-fast++ $HOME/AFLplusplus/afl-gcc-fast Source.c -o Source -lcrypto -lssl -lm -w
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>AFL_AUTORESUME=<span style=color:#ff0;font-weight:700>1</span> /usr/local/bin/afl-fuzz -i examples -o outputs_123_ASAN -s <span style=color:#ff0;font-weight:700>123</span> -- ./Source @@ outputs/output
</span></span></code></pre></div><p>And right away, I got a crash.<br><img src=ASAN.png alt=ASAN.png></p><p>Looking in the outputs_123_ASAN&rsquo;s crashes folder, I could see 1 interesting file. Time to try giving it to the Check utility:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./Check outputs_123_ASAN/default/crashes/id<span style=color:#0ff;font-weight:700>\:</span>000000<span style=color:#0ff;font-weight:700>\,</span>sig<span style=color:#0ff;font-weight:700>\:</span>06<span style=color:#0ff;font-weight:700>\,</span>src<span style=color:#0ff;font-weight:700>\:</span>000000<span style=color:#0ff;font-weight:700>\,</span>time<span style=color:#0ff;font-weight:700>\:</span>7398<span style=color:#0ff;font-weight:700>\,</span>execs<span style=color:#0ff;font-weight:700>\:</span>4154<span style=color:#0ff;font-weight:700>\,</span>op<span style=color:#0ff;font-weight:700>\:</span>havoc<span style=color:#0ff;font-weight:700>\,</span>rep<span style=color:#0ff;font-weight:700>\:</span><span style=color:#ff0;font-weight:700>4</span> 
</span></span><span style=display:flex><span>nsec2022_8831357
</span></span></code></pre></div><p>And we got the last flag of the warmup!</p><div class=chevrons><div id=navigation></div></div></section></article><footer><div class=footline></div><div><p>Weeeeeeeeeeeeeeee</p></div></footer><script src=/writeups/js/jquery-2.x.min.js></script>
<script type=text/javascript>var baseurl="https://n1trate.github.io/writeups"</script><script src=/writeups/js/clipboard.min.js></script>
<script src=/writeups/js/featherlight.min.js></script>
<script type=text/javascript src=/writeups/js/lunr.min.js></script>
<script type=text/javascript src=/writeups/js/auto-complete.js></script>
<script type=text/javascript src=/writeups/js/search.js></script>
<script src=/writeups/theme-flex/script.js></script>
<script src=https://n1trate.github.io/writeups/js/scripts.min.js></script></body></html>